# nix-zsh-completions start
zsh_add_plugin "spwhitt/nix-zsh-completions"
# adapted from https://github.com/spwhitt/nix-zsh-completions/issues/32#issuecomment-705315356
# fix for bad 'nix' completion (just the raw command)
function _nix() {
    local ifs_bk="$IFS"
    local input=("${(Q)words[@]}")
    IFS=$'\n'$'\t'
    local res=($(NIX_GET_COMPLETIONS=$((CURRENT - 1)) "$input[@]"))
    IFS="$ifs_bk"
    local tpe="$res[1]"
    local suggestions=(${res:1})
    if [[ "$tpe" == filenames ]]; then
        compadd -fa suggestions
    else
        compadd -a suggestions
    fi
}
# nix-zsh-completions end

# source zsh plugins that vary by platform
if [ "$(uname)" = "Darwin" ]; then
    source ~/.fzf.zsh

    source "$BREW_PREFIX/share/zsh-autosuggestions/zsh-autosuggestions.zsh"
    source "$BREW_PREFIX/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
elif [ "$(uname)" = "Linux" ]; then
	if [ -f "/etc/arch-release" ]; then
        # fzf
        source "/usr/share/fzf/key-bindings.zsh"
        source "/usr/share/fzf/completion.zsh"

        source "/usr/share/zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh"
        source "/usr/share/zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
	elif [ -f "/etc/debian_version" ]; then
        # fzf
        source "/usr/share/doc/fzf/examples/key-bindings.zsh"
        source "/usr/share/doc/fzf/examples/completion.zsh"

        source "/usr/share/zsh-autosuggestions/zsh-autosuggestions.zsh"
        source "/usr/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
	fi
fi

## Reduce latency when pressing <Esc>
export KEYTIMEOUT=1
# vi-mode implementations
# needs to be after zsh-autosuggestions ans zsh-syntax-highlighting
# to avoid conflicts
#zsh_add_file "vi-mode"
zsh_add_plugin "softmoth/zsh-vim-mode"
